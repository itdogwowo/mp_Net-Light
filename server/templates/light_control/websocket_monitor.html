<!-- templates/light_control/websocket_monitor.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }} - mp_Net-Light{% endblock %}

{% block content %}
<div class="content" style="max-width: 1200px; margin: 0 auto;">
  <h2 style="color:#667eea; margin-bottom:20px;">ğŸ”Œ WebSocket ç›£å¯Ÿå™¨</h2>
  
  <div style="display: grid; gap: 16px;">
    
    <!-- é€£æ¥æ§åˆ¶ -->
    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
      <h3 style="margin-top: 0;">é€£æ¥æ§åˆ¶</h3>
      
      <div style="display: grid; gap: 12px;">
        <div>
          <label style="font-weight: 600;">WebSocket URL:</label>
          <input id="wsUrl" type="text" 
                 value="ws://{{ request.get_host }}/ws/light/playback/" 
                 style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button id="connectBtn" class="btn" style="flex: 1;">ğŸ”— é€£æ¥</button>
          <button id="disconnectBtn" class="btn" style="flex: 1; background: #dc2626;">ğŸ”Œ æ–·é–‹</button>
        </div>
        
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px;">
          <span style="font-weight: 600;">ç‹€æ…‹:</span>
          <span id="connectionStatus" style="color: #dc2626;">âŒ æœªé€£æ¥</span>
        </div>
      </div>
    </div>
    
    <!-- ç™¼é€æ¸¬è©¦è¨Šæ¯ -->
    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
      <h3 style="margin-top: 0;">ç™¼é€æ¸¬è©¦è¨Šæ¯</h3>
      
      <div style="display: grid; gap: 12px;">
        <div>
          <label style="font-weight: 600;">è¨Šæ¯é¡å‹:</label>
          <select id="messageType" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="playback_init">playback_init - åˆå§‹åŒ–æ’­æ”¾å™¨</option>
            <option value="playback_play">playback_play - é–‹å§‹æ’­æ”¾</option>
            <option value="playback_pause">playback_pause - æš«åœ</option>
            <option value="playback_stop">playback_stop - åœæ­¢</option>
            <option value="playback_seek">playback_seek - è·³è½‰å¹€</option>
            <option value="playback_get_frame">playback_get_frame - ç²å–å–®å¹€</option>
            <option value="custom">custom - è‡ªå®šç¾© JSON</option>
          </select>
        </div>
        
        <div>
          <label style="font-weight: 600;">è¨Šæ¯å…§å®¹ï¼ˆJSONï¼‰:</label>
          <textarea id="messageContent" rows="6" 
                    style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace;">
{
  "type": "playback_init",
  "filename": "show.pxld",
  "slave_id": -1
}
          </textarea>
        </div>
        
        <button id="sendBtn" class="btn">ğŸ“¤ ç™¼é€è¨Šæ¯</button>
      </div>
    </div>
    
    <!-- è¨Šæ¯è¨˜éŒ„ -->
    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0;">ğŸ“ è¨Šæ¯è¨˜éŒ„</h3>
        <button id="clearLogBtn" class="btn" style="padding: 6px 12px; background: #6b7280;">æ¸…é™¤</button>
      </div>
      
      <div id="messageLog" 
           style="background: #1f2937; color: #e5e7eb; padding: 12px; border-radius: 6px; 
                  height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
        <div style="color: #9ca3af;">ç­‰å¾…é€£æ¥...</div>
      </div>
    </div>
    
    <!-- çµ±è¨ˆä¿¡æ¯ -->
    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
      <h3 style="margin-top: 0;">ğŸ“Š çµ±è¨ˆä¿¡æ¯</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div style="color: #6b7280; font-size: 0.9rem;">æ¥æ”¶è¨Šæ¯</div>
          <div id="statReceived" style="font-size: 1.5rem; font-weight: 600; color: #059669;">0</div>
        </div>
        
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div style="color: #6b7280; font-size: 0.9rem;">ç™¼é€è¨Šæ¯</div>
          <div id="statSent" style="font-size: 1.5rem; font-weight: 600; color: #2563eb;">0</div>
        </div>
        
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div style="color: #6b7280; font-size: 0.9rem;">éŒ¯èª¤æ¬¡æ•¸</div>
          <div id="statErrors" style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">0</div>
        </div>
        
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div style="color: #6b7280; font-size: 0.9rem;">é€£æ¥æ™‚é•·</div>
          <div id="statUptime" style="font-size: 1.5rem; font-weight: 600; color: #d97706;">0s</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<script>
// WebSocket ç›£å¯Ÿå™¨
(function() {
  'use strict';
  
  let ws = null;
  let connected = false;
  let stats = {
    received: 0,
    sent: 0,
    errors: 0,
    connectTime: null
  };
  
  // DOM å…ƒç´ 
  const wsUrlEl = document.getElementById('wsUrl');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const statusEl = document.getElementById('connectionStatus');
  const messageTypeEl = document.getElementById('messageType');
  const messageContentEl = document.getElementById('messageContent');
  const sendBtn = document.getElementById('sendBtn');
  const messageLog = document.getElementById('messageLog');
  const clearLogBtn = document.getElementById('clearLogBtn');
  
  // çµ±è¨ˆå…ƒç´ 
  const statReceived = document.getElementById('statReceived');
  const statSent = document.getElementById('statSent');
  const statErrors = document.getElementById('statErrors');
  const statUptime = document.getElementById('statUptime');
  
  // æ—¥èªŒå‡½æ•¸
  function log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
      info: '#9ca3af',
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b',
      sent: '#3b82f6',
      received: '#8b5cf6'
    };
    
    const logEntry = document.createElement('div');
    logEntry.style.marginBottom = '4px';
    logEntry.style.color = colors[type] || colors.info;
    logEntry.innerHTML = `<span style="color: #6b7280;">[${timestamp}]</span> ${message}`;
    
    messageLog.appendChild(logEntry);
    messageLog.scrollTop = messageLog.scrollHeight;
  }
  
  // æ›´æ–°çµ±è¨ˆ
  function updateStats() {
    statReceived.textContent = stats.received;
    statSent.textContent = stats.sent;
    statErrors.textContent = stats.errors;
    
    if (stats.connectTime) {
      const uptime = Math.floor((Date.now() - stats.connectTime) / 1000);
      statUptime.textContent = `${uptime}s`;
    } else {
      statUptime.textContent = '0s';
    }
  }
  
  // é€£æ¥ WebSocket
  function connect() {
    const url = wsUrlEl.value;
    
    log(`å˜—è©¦é€£æ¥åˆ°: ${url}`, 'info');
    
    try {
      ws = new WebSocket(url);
      
      ws.onopen = () => {
        connected = true;
        stats.connectTime = Date.now();
        statusEl.textContent = 'âœ… å·²é€£æ¥';
        statusEl.style.color = '#059669';
        log('WebSocket é€£æ¥æˆåŠŸ', 'success');
        updateStats();
      };
      
      ws.onmessage = (event) => {
        stats.received++;
        
        try {
          const data = JSON.parse(event.data);
          log(`â¬‡ï¸ æ¥æ”¶: ${JSON.stringify(data, null, 2)}`, 'received');
        } catch (error) {
          log(`â¬‡ï¸ æ¥æ”¶ (é JSON): ${event.data}`, 'received');
        }
        
        updateStats();
      };
      
      ws.onclose = (event) => {
        connected = false;
        stats.connectTime = null;
        statusEl.textContent = 'âŒ æœªé€£æ¥';
        statusEl.style.color = '#dc2626';
        log(`WebSocket é€£æ¥é—œé–‰ (code: ${event.code}, reason: ${event.reason || 'ç„¡'})`, 'warning');
        updateStats();
      };
      
      ws.onerror = (error) => {
        stats.errors++;
        log(`WebSocket éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        updateStats();
      };
      
    } catch (error) {
      stats.errors++;
      log(`é€£æ¥å¤±æ•—: ${error.message}`, 'error');
      updateStats();
    }
  }
  
  // æ–·é–‹é€£æ¥
  function disconnect() {
    if (ws) {
      ws.close();
      ws = null;
      connected = false;
      log('æ‰‹å‹•æ–·é–‹é€£æ¥', 'info');
    }
  }
  
  // ç™¼é€è¨Šæ¯
  function sendMessage() {
    if (!connected) {
      log('è«‹å…ˆé€£æ¥ WebSocket', 'error');
      return;
    }
    
    try {
      const content = messageContentEl.value;
      const data = JSON.parse(content);
      
      ws.send(JSON.stringify(data));
      stats.sent++;
      
      log(`â¬†ï¸ ç™¼é€: ${JSON.stringify(data, null, 2)}`, 'sent');
      updateStats();
      
    } catch (error) {
      stats.errors++;
      log(`ç™¼é€å¤±æ•—: ${error.message}`, 'error');
      updateStats();
    }
  }
  
  // æ¸…é™¤æ—¥èªŒ
  function clearLog() {
    messageLog.innerHTML = '<div style="color: #9ca3af;">æ—¥èªŒå·²æ¸…é™¤</div>';
  }
  
  // è¨Šæ¯é¡å‹è®Šæ›´æ™‚æ›´æ–°ç¯„ä¾‹å…§å®¹
  messageTypeEl.addEventListener('change', () => {
    const type = messageTypeEl.value;
    
    const examples = {
      playback_init: {
        type: 'playback_init',
        filename: 'show.pxld',
        slave_id: -1
      },
      playback_play: {
        type: 'playback_play',
        frame: 0
      },
      playback_pause: {
        type: 'playback_pause'
      },
      playback_stop: {
        type: 'playback_stop'
      },
      playback_seek: {
        type: 'playback_seek',
        frame: 10
      },
      playback_get_frame: {
        type: 'playback_get_frame',
        frame: 0,
        slave_id: 0
      },
      custom: {
        type: 'custom',
        message: 'your message here'
      }
    };
    
    if (examples[type]) {
      messageContentEl.value = JSON.stringify(examples[type], null, 2);
    }
  });
  
  // ç¶å®šäº‹ä»¶
  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);
  sendBtn.addEventListener('click', sendMessage);
  clearLogBtn.addEventListener('click', clearLog);
  
  // å®šæ™‚æ›´æ–°é‹è¡Œæ™‚é–“
  setInterval(updateStats, 1000);
  
  // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
  window.addEventListener('beforeunload', () => {
    if (ws) ws.close();
  });
  
})();
</script>
{% endblock %}