<!-- templates/light_control/websocket_monitor.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }} - mp_Net-Light{% endblock %}

{% block content %}
<div class="content" style="max-width: 1600px; margin: 0 auto;">
  <h2 style="color:#667eea; margin-bottom:20px;">ğŸ”Œ WebSocket ç›£å¯Ÿå™¨ï¼ˆå»£æ’­æˆ¿é–“æ¨¡å¼ï¼‰</h2>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr 400px; gap: 16px;">
    
    <!-- å·¦å´ï¼šé€£æ¥å’Œæ§åˆ¶ -->
    <div style="display: grid; gap: 16px;">
      
      <!-- é€£æ¥æ§åˆ¶ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">é€£æ¥æ§åˆ¶</h3>
        
        <div style="display: grid; gap: 12px;">
          <div>
            <label style="font-weight: 600;">é€£æ¥æ¨¡å¼:</label>
            <select id="connectionMode" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="monitor">ğŸ” ç›£å¯Ÿæ¨¡å¼ï¼ˆåªæ¥æ”¶ï¼Œä¸ç™¼é€æ§åˆ¶ï¼‰</option>
              <option value="playback">ğŸ® æ’­æ”¾æ¨¡å¼ï¼ˆå¯æ§åˆ¶æ’­æ”¾ï¼‰</option>
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600;">WebSocket URL:</label>
            <input id="wsUrl" type="text" 
                   value="ws://{{ request.get_host }}/ws/light/monitor/" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" readonly>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button id="connectBtn" class="btn" style="flex: 1;">ğŸ”— é€£æ¥</button>
            <button id="disconnectBtn" class="btn" style="flex: 1; background: #dc2626;">ğŸ”Œ æ–·é–‹</button>
          </div>
          
          <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px;">
            <span style="font-weight: 600;">ç‹€æ…‹:</span>
            <span id="connectionStatus" style="color: #dc2626;">âŒ æœªé€£æ¥</span>
          </div>
        </div>
      </div>
      
      <!-- ç™¼é€æ¸¬è©¦è¨Šæ¯ -->
      <div id="sendPanel" style="background: #f3f4f6; padding: 16px; border-radius: 8px; opacity: 0.5;">
        <h3 style="margin-top: 0;">ç™¼é€æ¸¬è©¦è¨Šæ¯ï¼ˆæ’­æ”¾æ¨¡å¼å°ˆç”¨ï¼‰</h3>
        
        <div style="display: grid; gap: 12px;">
          <div>
            <label style="font-weight: 600;">è¨Šæ¯é¡å‹:</label>
            <select id="messageType" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="playback_init">playback_init - åˆå§‹åŒ–æ’­æ”¾å™¨</option>
              <option value="playback_play">playback_play - é–‹å§‹æ’­æ”¾</option>
              <option value="playback_pause">playback_pause - æš«åœ</option>
              <option value="playback_stop">playback_stop - åœæ­¢</option>
              <option value="playback_seek">playback_seek - è·³è½‰å¹€</option>
              <option value="playback_get_frame">playback_get_frame - ç²å–å–®å¹€</option>
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600;">è¨Šæ¯å…§å®¹ï¼ˆJSONï¼‰:</label>
            <textarea id="messageContent" rows="6" 
                      style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 12px;">
{
  "type": "playback_init",
  "filename": "show.pxld",
  "slave_id": -1
}
            </textarea>
          </div>
          
          <button id="sendBtn" class="btn" disabled>ğŸ“¤ ç™¼é€è¨Šæ¯</button>
        </div>
      </div>
      
      <!-- çµ±è¨ˆä¿¡æ¯ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ“Š çµ±è¨ˆä¿¡æ¯</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">æ¥æ”¶è¨Šæ¯</div>
            <div id="statReceived" style="font-size: 1.5rem; font-weight: 600; color: #059669;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">ç™¼é€è¨Šæ¯</div>
            <div id="statSent" style="font-size: 1.5rem; font-weight: 600; color: #2563eb;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">frame_data</div>
            <div id="statFrameData" style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">éŒ¯èª¤æ¬¡æ•¸</div>
            <div id="statErrors" style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">é€£æ¥æ™‚é•·</div>
            <div id="statUptime" style="font-size: 1.5rem; font-weight: 600; color: #d97706;">0s</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">å¯¦æ™‚ FPS</div>
            <div id="statFps" style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">--</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ä¸­é–“ï¼šè¨Šæ¯è¨˜éŒ„ -->
    <div style="display: grid; gap: 16px;">
      
      <!-- è¨Šæ¯éæ¿¾ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ” è¨Šæ¯éæ¿¾</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterConnection" checked>
            <span style="font-size: 0.9rem;">é€£æ¥è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterClientMsg" checked>
            <span style="font-size: 0.9rem;">å®¢æˆ¶ç«¯è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterFrameData">
            <span style="font-size: 0.9rem;">frame_dataï¼ˆå–®ï¼‰</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterFrameDataAll" checked>
            <span style="font-size: 0.9rem;">frame_data_allï¼ˆç¸½ï¼‰</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterPlayback" checked>
            <span style="font-size: 0.9rem;">æ’­æ”¾æ§åˆ¶</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterErrors" checked>
            <span style="font-size: 0.9rem;">éŒ¯èª¤è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
            <input type="checkbox" id="autoScroll" checked>
            <span style="font-size: 0.9rem;">è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
            <input type="checkbox" id="showDetails" checked>
            <span style="font-size: 0.9rem;">é¡¯ç¤ºè©³ç´°æ•¸æ“šï¼ˆé»æ“Šå±•é–‹ï¼‰</span>
          </label>
        </div>
      </div>
      
      <!-- è¨Šæ¯è¨˜éŒ„ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">ğŸ“ è¨Šæ¯è¨˜éŒ„ï¼ˆå»£æ’­æˆ¿é–“ï¼‰</h3>
          <div style="display: flex; gap: 8px;">
            <button id="pauseLogBtn" class="btn" style="padding: 6px 12px; background: #f59e0b;">â¸ï¸ æš«åœ</button>
            <button id="clearLogBtn" class="btn" style="padding: 6px 12px; background: #6b7280;">ğŸ—‘ï¸ æ¸…é™¤</button>
          </div>
        </div>
        
        <div id="messageLog" 
             style="background: #1f2937; color: #e5e7eb; padding: 12px; border-radius: 6px; 
                    height: 700px; overflow-y: auto; font-family: monospace; font-size: 11px; line-height: 1.6;">
          <div style="color: #9ca3af;">ç­‰å¾…é€£æ¥...</div>
        </div>
      </div>
    </div>
    
    <!-- å³å´ï¼šå¹€æ•¸æ“šè©³æƒ… -->
    <div style="display: grid; gap: 16px;">
      
      <!-- ç•¶å‰å¹€ä¿¡æ¯ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ¬ ç•¶å‰å¹€ä¿¡æ¯</h3>
        
        <div id="currentFrameInfo" style="background: white; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px;">
          <div style="color: #6b7280;">ç­‰å¾…å¹€æ•¸æ“š...</div>
        </div>
      </div>
      
      <!-- Slave æ•¸æ“šè©³æƒ… -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1;">
        <h3 style="margin-top: 0;">ğŸ“¦ Slave æ•¸æ“šè©³æƒ…</h3>
        
        <div id="slaveDetails" 
             style="background: white; padding: 12px; border-radius: 6px; 
                    height: 600px; overflow-y: auto; font-family: monospace; font-size: 11px;">
          <div style="color: #6b7280;">é¸æ“‡ä¸€å€‹ slave æŸ¥çœ‹è©³æƒ…...</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- ğŸ”¥ ä½¿ç”¨æ¨¡å¡ŠåŒ– JavaScript -->
<script type="module">
import { WebSocketMonitor } from '{% static "netlight/js/mapping/monitor.js" %}';

(function() {
  'use strict';
  
  // å‰µå»º Monitor å¯¦ä¾‹
  const monitor = new WebSocketMonitor();
  
  // åˆå§‹åŒ– DOM å¼•ç”¨
  monitor.initDOM({
    // é€£æ¥æ§åˆ¶
    wsUrlEl: document.getElementById('wsUrl'),
    connectionModeEl: document.getElementById('connectionMode'),
    connectBtn: document.getElementById('connectBtn'),
    disconnectBtn: document.getElementById('disconnectBtn'),
    statusEl: document.getElementById('connectionStatus'),
    
    // ç™¼é€é¢æ¿
    messageTypeEl: document.getElementById('messageType'),
    messageContentEl: document.getElementById('messageContent'),
    sendBtn: document.getElementById('sendBtn'),
    sendPanel: document.getElementById('sendPanel'),
    
    // æ—¥èªŒå€åŸŸ
    messageLog: document.getElementById('messageLog'),
    clearLogBtn: document.getElementById('clearLogBtn'),
    pauseLogBtn: document.getElementById('pauseLogBtn'),
    
    // è©³æƒ…é¡¯ç¤º
    currentFrameInfo: document.getElementById('currentFrameInfo'),
    slaveDetails: document.getElementById('slaveDetails'),
    
    // éæ¿¾å™¨
    filterConnection: document.getElementById('filterConnection'),
    filterClientMsg: document.getElementById('filterClientMsg'),
    filterFrameData: document.getElementById('filterFrameData'),
    filterFrameDataAll: document.getElementById('filterFrameDataAll'),
    filterPlayback: document.getElementById('filterPlayback'),
    filterErrors: document.getElementById('filterErrors'),
    autoScroll: document.getElementById('autoScroll'),
    showDetails: document.getElementById('showDetails'),
    
    // çµ±è¨ˆé¡¯ç¤º
    statReceived: document.getElementById('statReceived'),
    statSent: document.getElementById('statSent'),
    statFrameData: document.getElementById('statFrameData'),
    statErrors: document.getElementById('statErrors'),
    statUptime: document.getElementById('statUptime'),
    statFps: document.getElementById('statFps'),
  });
  
  // é€£æ¥æ¨¡å¼è®Šæ›´
  monitor.dom.connectionModeEl.addEventListener('change', () => {
    const mode = monitor.dom.connectionModeEl.value;
    monitor.setMode(mode);
    
    if (mode === 'monitor') {
      monitor.dom.wsUrlEl.value = `ws://{{ request.get_host }}/ws/light/monitor/`;
      monitor.dom.sendPanel.style.opacity = '0.5';
      monitor.dom.sendBtn.disabled = true;
    } else {
      monitor.dom.wsUrlEl.value = `ws://{{ request.get_host }}/ws/light/playback/`;
      monitor.dom.sendPanel.style.opacity = '1';
      monitor.dom.sendBtn.disabled = false;
    }
  });
  
  // é€£æ¥/æ–·é–‹
  monitor.dom.connectBtn.addEventListener('click', () => {
    const url = monitor.dom.wsUrlEl.value;
    monitor.connect(url);
  });
  
  monitor.dom.disconnectBtn.addEventListener('click', () => {
    monitor.disconnect();
  });
  
  // ç™¼é€è¨Šæ¯
  monitor.dom.sendBtn.addEventListener('click', () => {
    try {
      const content = monitor.dom.messageContentEl.value;
      const data = JSON.parse(content);
      monitor.send(data);
    } catch (error) {
      monitor.log(`ç™¼é€å¤±æ•—: ${error.message}`, 'error');
    }
  });
  
  // Ctrl+Enter ç™¼é€
  monitor.dom.messageContentEl.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      monitor.dom.sendBtn.click();
    }
  });
  
  // æ¸…é™¤/æš«åœæ—¥èªŒ
  monitor.dom.clearLogBtn.addEventListener('click', () => {
    monitor.clearLog();
  });
  
  monitor.dom.pauseLogBtn.addEventListener('click', () => {
    monitor.toggleLogPause();
  });
  
  // è¨Šæ¯é¡å‹è®Šæ›´æ™‚æ›´æ–°ç¯„ä¾‹
  monitor.dom.messageTypeEl.addEventListener('change', () => {
    const type = monitor.dom.messageTypeEl.value;
    const examples = {
      playback_init: { type: 'playback_init', filename: 'show.pxld', slave_id: -1 },
      playback_play: { type: 'playback_play', frame: 0 },
      playback_pause: { type: 'playback_pause' },
      playback_stop: { type: 'playback_stop' },
      playback_seek: { type: 'playback_seek', frame: 100 },
      playback_get_frame: { type: 'playback_get_frame', frame: 0, slave_id: 0 }
    };
    
    if (examples[type]) {
      monitor.dom.messageContentEl.value = JSON.stringify(examples[type], null, 2);
    }
  });
  
  // å®šæ™‚æ›´æ–°çµ±è¨ˆ
  setInterval(() => monitor.updateStats(), 500);
  
  // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
  window.addEventListener('beforeunload', () => {
    monitor.disconnect();
  });
  
  // è‡ªå‹•é€£æ¥
  setTimeout(() => {
    if (!monitor.connected) {
      monitor.log('è‡ªå‹•é€£æ¥åˆ°ç›£å¯Ÿæ¨¡å¼...', 'info');
      monitor.connect(`ws://{{ request.get_host }}/ws/light/monitor/`);
    }
  }, 500);
  
})();
</script>

<style>
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #667eea;
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn:hover:not(:disabled) {
  background: #5568d3;
  transform: translateY(-1px);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

pre {
  background: rgba(0,0,0,0.2);
  padding: 4px 8px;
  border-radius: 4px;
  overflow-x: auto;
}
</style>
{% endblock %}