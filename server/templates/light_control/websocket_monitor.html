<!-- templates/light_control/websocket_monitor.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }} - mp_Net-Light{% endblock %}

{% block content %}
<div class="content" style="max-width: 1600px; margin: 0 auto;">
  <h2 style="color:#667eea; margin-bottom:20px;">ğŸ”Œ WebSocket ç›£å¯Ÿå™¨ï¼ˆå»£æ’­æˆ¿é–“æ¨¡å¼ï¼‰</h2>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr 400px; gap: 16px;">
    
    <!-- å·¦å´ï¼šé€£æ¥å’Œæ§åˆ¶ -->
    <div style="display: grid; gap: 16px;">
      
      <!-- é€£æ¥æ§åˆ¶ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">é€£æ¥æ§åˆ¶</h3>
        
        <div style="display: grid; gap: 12px;">
          <div>
            <label style="font-weight: 600;">é€£æ¥æ¨¡å¼:</label>
            <select id="connectionMode" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="monitor">ğŸ” ç›£å¯Ÿæ¨¡å¼ï¼ˆåªæ¥æ”¶ï¼Œä¸ç™¼é€æ§åˆ¶ï¼‰</option>
              <option value="playback">ğŸ® æ’­æ”¾æ¨¡å¼ï¼ˆå¯æ§åˆ¶æ’­æ”¾ï¼‰</option>
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600;">WebSocket URL:</label>
            <input id="wsUrl" type="text" 
                   value="ws://{{ request.get_host }}/ws/light/monitor/" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" readonly>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button id="connectBtn" class="btn" style="flex: 1;">ğŸ”— é€£æ¥</button>
            <button id="disconnectBtn" class="btn" style="flex: 1; background: #dc2626;">ğŸ”Œ æ–·é–‹</button>
          </div>
          
          <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px;">
            <span style="font-weight: 600;">ç‹€æ…‹:</span>
            <span id="connectionStatus" style="color: #dc2626;">âŒ æœªé€£æ¥</span>
          </div>
        </div>
      </div>
      
      <!-- ç™¼é€æ¸¬è©¦è¨Šæ¯ -->
      <div id="sendPanel" style="background: #f3f4f6; padding: 16px; border-radius: 8px; opacity: 0.5;">
        <h3 style="margin-top: 0;">ç™¼é€æ¸¬è©¦è¨Šæ¯ï¼ˆæ’­æ”¾æ¨¡å¼å°ˆç”¨ï¼‰</h3>
        
        <div style="display: grid; gap: 12px;">
          <div>
            <label style="font-weight: 600;">è¨Šæ¯é¡å‹:</label>
            <select id="messageType" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="playback_init">playback_init - åˆå§‹åŒ–æ’­æ”¾å™¨</option>
              <option value="playback_play">playback_play - é–‹å§‹æ’­æ”¾</option>
              <option value="playback_pause">playback_pause - æš«åœ</option>
              <option value="playback_stop">playback_stop - åœæ­¢</option>
              <option value="playback_seek">playback_seek - è·³è½‰å¹€</option>
              <option value="playback_get_frame">playback_get_frame - ç²å–å–®å¹€</option>
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600;">è¨Šæ¯å…§å®¹ï¼ˆJSONï¼‰:</label>
            <textarea id="messageContent" rows="6" 
                      style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 12px;">
{
  "type": "playback_init",
  "filename": "show.pxld",
  "slave_id": -1
}
            </textarea>
          </div>
          
          <button id="sendBtn" class="btn" disabled>ğŸ“¤ ç™¼é€è¨Šæ¯</button>
        </div>
      </div>
      
      <!-- çµ±è¨ˆä¿¡æ¯ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ“Š çµ±è¨ˆä¿¡æ¯</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">æ¥æ”¶è¨Šæ¯</div>
            <div id="statReceived" style="font-size: 1.5rem; font-weight: 600; color: #059669;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">ç™¼é€è¨Šæ¯</div>
            <div id="statSent" style="font-size: 1.5rem; font-weight: 600; color: #2563eb;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">frame_data</div>
            <div id="statFrameData" style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">éŒ¯èª¤æ¬¡æ•¸</div>
            <div id="statErrors" style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">0</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">é€£æ¥æ™‚é•·</div>
            <div id="statUptime" style="font-size: 1.5rem; font-weight: 600; color: #d97706;">0s</div>
          </div>
          
          <div style="background: white; padding: 12px; border-radius: 6px;">
            <div style="color: #6b7280; font-size: 0.9rem;">å¯¦æ™‚ FPS</div>
            <div id="statFps" style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">--</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ä¸­é–“ï¼šè¨Šæ¯è¨˜éŒ„ -->
    <div style="display: grid; gap: 16px;">
      
      <!-- è¨Šæ¯éæ¿¾ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ” è¨Šæ¯éæ¿¾</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterConnection" checked>
            <span style="font-size: 0.9rem;">é€£æ¥è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterClientMsg" checked>
            <span style="font-size: 0.9rem;">å®¢æˆ¶ç«¯è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterFrameData">
            <span style="font-size: 0.9rem;">frame_dataï¼ˆå–®ï¼‰</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterFrameDataAll" checked>
            <span style="font-size: 0.9rem;">frame_data_allï¼ˆç¸½ï¼‰</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterPlayback" checked>
            <span style="font-size: 0.9rem;">æ’­æ”¾æ§åˆ¶</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="filterErrors" checked>
            <span style="font-size: 0.9rem;">éŒ¯èª¤è¨Šæ¯</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
            <input type="checkbox" id="autoScroll" checked>
            <span style="font-size: 0.9rem;">è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 8px; grid-column: 1 / -1;">
            <input type="checkbox" id="showDetails" checked>
            <span style="font-size: 0.9rem;">é¡¯ç¤ºè©³ç´°æ•¸æ“šï¼ˆé»æ“Šå±•é–‹ï¼‰</span>
          </label>
        </div>
      </div>
      
      <!-- è¨Šæ¯è¨˜éŒ„ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">ğŸ“ è¨Šæ¯è¨˜éŒ„ï¼ˆå»£æ’­æˆ¿é–“ï¼‰</h3>
          <div style="display: flex; gap: 8px;">
            <button id="pauseLogBtn" class="btn" style="padding: 6px 12px; background: #f59e0b;">â¸ï¸ æš«åœ</button>
            <button id="clearLogBtn" class="btn" style="padding: 6px 12px; background: #6b7280;">ğŸ—‘ï¸ æ¸…é™¤</button>
          </div>
        </div>
        
        <div id="messageLog" 
             style="background: #1f2937; color: #e5e7eb; padding: 12px; border-radius: 6px; 
                    height: 700px; overflow-y: auto; font-family: monospace; font-size: 11px; line-height: 1.6;">
          <div style="color: #9ca3af;">ç­‰å¾…é€£æ¥...</div>
        </div>
      </div>
    </div>
    
    <!-- å³å´ï¼šå¹€æ•¸æ“šè©³æƒ… -->
    <div style="display: grid; gap: 16px;">
      
      <!-- ç•¶å‰å¹€ä¿¡æ¯ -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
        <h3 style="margin-top: 0;">ğŸ¬ ç•¶å‰å¹€ä¿¡æ¯</h3>
        
        <div id="currentFrameInfo" style="background: white; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px;">
          <div style="color: #6b7280;">ç­‰å¾…å¹€æ•¸æ“š...</div>
        </div>
      </div>
      
      <!-- Slave æ•¸æ“šè©³æƒ… -->
      <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1;">
        <h3 style="margin-top: 0;">ğŸ“¦ Slave æ•¸æ“šè©³æƒ…</h3>
        
        <div id="slaveDetails" 
             style="background: white; padding: 12px; border-radius: 6px; 
                    height: 600px; overflow-y: auto; font-family: monospace; font-size: 11px;">
          <div style="color: #6b7280;">é¸æ“‡ä¸€å€‹ slave æŸ¥çœ‹è©³æƒ…...</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<script>
// WebSocket ç›£å¯Ÿå™¨ - è©³ç´°æ•¸æ“šæŸ¥çœ‹ç‰ˆæœ¬
(function() {
  'use strict';
  
  let ws = null;
  let connected = false;
  let mode = 'monitor';
  let logPaused = false;
  let lastFrameData = null;  // å„²å­˜æœ€æ–°çš„å¹€æ•¸æ“š
  let stats = {
    received: 0,
    sent: 0,
    errors: 0,
    frameData: 0,
    connectTime: null,
    lastFrameTime: 0,
    frameTimes: [],
    clients: new Set()
  };
  
  // DOM å…ƒç´ 
  const wsUrlEl = document.getElementById('wsUrl');
  const connectionModeEl = document.getElementById('connectionMode');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const statusEl = document.getElementById('connectionStatus');
  const messageTypeEl = document.getElementById('messageType');
  const messageContentEl = document.getElementById('messageContent');
  const sendBtn = document.getElementById('sendBtn');
  const sendPanel = document.getElementById('sendPanel');
  const messageLog = document.getElementById('messageLog');
  const clearLogBtn = document.getElementById('clearLogBtn');
  const pauseLogBtn = document.getElementById('pauseLogBtn');
  const currentFrameInfo = document.getElementById('currentFrameInfo');
  const slaveDetails = document.getElementById('slaveDetails');
  
  // éæ¿¾å™¨
  const filterConnection = document.getElementById('filterConnection');
  const filterClientMsg = document.getElementById('filterClientMsg');
  const filterFrameData = document.getElementById('filterFrameData');
  const filterFrameDataAll = document.getElementById('filterFrameDataAll');
  const filterPlayback = document.getElementById('filterPlayback');
  const filterErrors = document.getElementById('filterErrors');
  const autoScroll = document.getElementById('autoScroll');
  const showDetails = document.getElementById('showDetails');
  
  // çµ±è¨ˆå…ƒç´ 
  const statReceived = document.getElementById('statReceived');
  const statSent = document.getElementById('statSent');
  const statFrameData = document.getElementById('statFrameData');
  const statErrors = document.getElementById('statErrors');
  const statUptime = document.getElementById('statUptime');
  const statFps = document.getElementById('statFps');
  
  // Base64 è§£ç¢¼å‡½æ•¸
  function b64ToU8(b64) {
    const bin = atob(b64);
    const out = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
    return out;
  }
  
  // é¡¯ç¤ºç•¶å‰å¹€ä¿¡æ¯
  function displayCurrentFrame(data) {
    lastFrameData = data;
    
    let html = '<div style="display: grid; gap: 8px;">';
    html += `<div><strong>å¹€è™Ÿ:</strong> ${data.frame}</div>`;
    html += `<div><strong>æ™‚é–“:</strong> ${new Date(data.timestamp).toLocaleTimeString()}</div>`;
    html += `<div><strong>ä¾†æº:</strong> ${data.device_id || 'unknown'}</div>`;
    
    if (data.slaves) {
      html += `<div><strong>Slaves:</strong> ${data.slaves.length} å€‹</div>`;
      html += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">';
      html += '<div style="font-weight: 600; margin-bottom: 4px;">é»æ“Š Slave æŸ¥çœ‹è©³æƒ…:</div>';
      
      for (const slave of data.slaves) {
        const rgbwSize = slave.rgbw_b64.length;
        const pixelCount = Math.floor(rgbwSize * 3 / 4 / 4); // base64 -> bytes -> pixels
        
        html += `
          <button onclick="viewSlaveDetail(${slave.slave_id})" 
                  style="display: block; width: 100%; padding: 6px; margin: 2px 0; 
                         background: #e5e7eb; border: 1px solid #d1d5db; border-radius: 4px; 
                         cursor: pointer; text-align: left; font-family: monospace; font-size: 11px;">
            Slave ${slave.slave_id}: ${pixelCount} LEDs, ${rgbwSize} chars
          </button>
        `;
      }
      html += '</div>';
    }
    
    html += '</div>';
    currentFrameInfo.innerHTML = html;
  }
  
  // æŸ¥çœ‹ Slave è©³ç´°æ•¸æ“š
  window.viewSlaveDetail = function(slaveId) {
    if (!lastFrameData || !lastFrameData.slaves) return;
    
    const slave = lastFrameData.slaves.find(s => s.slave_id === slaveId);
    if (!slave) return;
    
    const rgbwBytes = b64ToU8(slave.rgbw_b64);
    const pixelCount = rgbwBytes.length / 4;
    
    let html = `<div style="padding: 8px;">`;
    html += `<h4 style="margin: 0 0 12px 0; color: #667eea;">Slave ${slaveId} è©³ç´°æ•¸æ“š</h4>`;
    html += `<div style="margin-bottom: 12px;">`;
    html += `<div><strong>ç¸½åƒç´ æ•¸:</strong> ${pixelCount}</div>`;
    html += `<div><strong>æ•¸æ“šå¤§å°:</strong> ${rgbwBytes.length} bytes</div>`;
    html += `</div>`;
    
    // é¡¯ç¤ºå‰ 50 å€‹åƒç´ çš„æ•¸æ“š
    html += `<div style="margin-bottom: 8px; font-weight: 600;">å‰ 50 å€‹åƒç´ çš„ RGBW å€¼:</div>`;
    html += `<div style="max-height: 500px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px;">`;
    
    const displayCount = Math.min(50, pixelCount);
    for (let i = 0; i < displayCount; i++) {
      const offset = i * 4;
      const r = rgbwBytes[offset];
      const g = rgbwBytes[offset + 1];
      const b = rgbwBytes[offset + 2];
      const w = rgbwBytes[offset + 3];
      
      // é¡¯ç¤ºé¡è‰²é è¦½
      const rgbColor = `rgb(${r},${g},${b})`;
      const brightness = r === 0 && g === 0 && b === 0 && w > 0 ? w : Math.max(r, g, b);
      const textColor = brightness > 128 ? '#000' : '#fff';
      
      html += `
        <div style="display: flex; align-items: center; gap: 8px; margin: 2px 0; padding: 4px; 
                    background: ${i % 2 === 0 ? '#fff' : '#f3f4f6'}; border-radius: 2px;">
          <div style="width: 30px; text-align: right; color: #6b7280;">${i}:</div>
          <div style="width: 20px; height: 20px; background: ${rgbColor}; border: 1px solid #d1d5db; border-radius: 2px;"></div>
          <div style="flex: 1;">
            R:<span style="color: #ef4444;">${String(r).padStart(3, ' ')}</span>
            G:<span style="color: #10b981;">${String(g).padStart(3, ' ')}</span>
            B:<span style="color: #3b82f6;">${String(b).padStart(3, ' ')}</span>
            W:<span style="color: #f59e0b;">${String(w).padStart(3, ' ')}</span>
          </div>
        </div>
      `;
    }
    
    if (pixelCount > 50) {
      html += `<div style="color: #6b7280; text-align: center; margin-top: 8px;">... é‚„æœ‰ ${pixelCount - 50} å€‹åƒç´ </div>`;
    }
    
    html += `</div></div>`;
    slaveDetails.innerHTML = html;
  };
  
  // æ—¥èªŒå‡½æ•¸ï¼ˆå¸¶è©³ç´°ä¿¡æ¯ï¼‰
  function log(message, type = 'info', data = null) {
    if (logPaused) return;
    
    // éæ¿¾æª¢æŸ¥
    const filterMap = {
      'connection': filterConnection,
      'disconnection': filterConnection,
      'client_message': filterClientMsg,
      'frame_data': filterFrameData,
      'frame_data_all': filterFrameDataAll,
      'playback_started': filterPlayback,
      'playback_paused': filterPlayback,
      'playback_stopped': filterPlayback,
      'playback_ready': filterPlayback,
      'error': filterErrors,
      'playback_error': filterErrors,
    };
    
    if (data && data.type && filterMap[data.type] && !filterMap[data.type].checked) {
      return;
    }
    
    const timestamp = new Date().toLocaleTimeString() + '.' + String(Date.now() % 1000).padStart(3, '0');
    const colors = {
      info: '#9ca3af',
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b',
      sent: '#3b82f6',
      received: '#8b5cf6',
      connection: '#10b981',
      client_message: '#3b82f6',
      frame_data: '#06b6d4',
      frame_data_all: '#a855f7',
      playback: '#f59e0b'
    };
    
    const logEntry = document.createElement('div');
    logEntry.style.marginBottom = '6px';
    logEntry.style.borderLeft = `3px solid ${colors[type] || colors.info}`;
    logEntry.style.paddingLeft = '8px';
    logEntry.style.paddingTop = '2px';
    logEntry.style.paddingBottom = '2px';
    logEntry.style.cursor = 'pointer';
    
    let content = `<span style="color: #6b7280;">[${timestamp}]</span> <span style="color: ${colors[type]}; font-weight: 600;">${message}</span>`;
    
    // å¦‚æœæœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæ‘˜è¦
    if (data) {
      // æ›´æ–°ç•¶å‰å¹€ä¿¡æ¯
      if (data.type === 'frame_data_all') {
        displayCurrentFrame(data);
      }
      
      // è¨˜éŒ„å®¢æˆ¶ç«¯
      if (data.device_id) {
        stats.clients.add(data.device_id);
      }
      
      if (data.type === 'frame_data') {
        const pixelCount = Math.floor(data.rgbw_b64.length * 3 / 4 / 4);
        content += `<div style="color: #6b7280; font-size: 0.85em; margin-left: 20px;">å¹€: ${data.frame}, Slave: ${data.slave_id}, LEDs: ${pixelCount}, ä¾†æº: ${data.device_id || 'unknown'}</div>`;
      } else if (data.type === 'frame_data_all') {
        let totalPixels = 0;
        let totalDataSize = 0;
        
        for (const slave of data.slaves) {
          const pixelCount = Math.floor(slave.rgbw_b64.length * 3 / 4 / 4);
          totalPixels += pixelCount;
          totalDataSize += slave.rgbw_b64.length;
        }
        
        content += `<div style="color: #6b7280; font-size: 0.85em; margin-left: 20px;">`;
        content += `å¹€: ${data.frame}, Slaves: ${data.slaves.length} å€‹, ç¸½ LEDs: ${totalPixels}, ç¸½æ•¸æ“š: ${totalDataSize} chars, ä¾†æº: ${data.device_id || 'unknown'}`;
        content += `</div>`;
        
        // æ·»åŠ è©³ç´°ä¿¡æ¯ï¼ˆå¯å±•é–‹ï¼‰
        if (showDetails.checked) {
          const detailId = `detail_${Date.now()}_${Math.random()}`;
          content += `<div id="${detailId}" style="display: none; margin-left: 20px; margin-top: 4px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.9em;">`;
          
          for (const slave of data.slaves) {
            const pixelCount = Math.floor(slave.rgbw_b64.length * 3 / 4 / 4);
            const rgbwBytes = b64ToU8(slave.rgbw_b64);
            
            // è¨ˆç®—å¹³å‡äº®åº¦
            let totalBrightness = 0;
            for (let i = 0; i < Math.min(pixelCount, 10); i++) {
              const offset = i * 4;
              totalBrightness += Math.max(rgbwBytes[offset], rgbwBytes[offset+1], rgbwBytes[offset+2], rgbwBytes[offset+3]);
            }
            const avgBrightness = Math.floor(totalBrightness / Math.min(pixelCount, 10));
            
            content += `<div style="margin: 2px 0;">Slave ${slave.slave_id}: ${pixelCount} LEDs, å¹³å‡äº®åº¦: ${avgBrightness}</div>`;
          }
          
          content += `</div>`;
          
          // é»æ“Šå±•é–‹/æ”¶èµ·
          logEntry.addEventListener('click', () => {
            const detailEl = document.getElementById(detailId);
            if (detailEl) {
              detailEl.style.display = detailEl.style.display === 'none' ? 'block' : 'none';
            }
          });
        }
        
      } else if (data.type === 'client_message') {
        content += `<div style="color: #3b82f6; font-size: 0.85em; margin-left: 20px;">å®¢æˆ¶ç«¯ ${data.device_id} ç™¼é€: ${data.data.type}</div>`;
      } else if (data.type === 'playback_ready') {
        content += `<div style="color: #6b7280; font-size: 0.85em; margin-left: 20px;">FPS: ${data.fps}, ç¸½å¹€æ•¸: ${data.total_frames}, Slaves: ${data.total_slaves}, Slave IDs: [${data.slave_ids.join(', ')}]</div>`;
      } else {
        const summary = { ...data };
        delete summary.rgbw_b64;
        if (summary.slaves) {
          summary.slaves = `[${summary.slaves.length} slaves]`;
        }
        content += `<div style="color: #6b7280; font-size: 0.85em; margin-left: 20px;"><pre style="margin: 0; max-height: 100px; overflow: auto;">${JSON.stringify(summary, null, 2)}</pre></div>`;
      }
    }
    
    logEntry.innerHTML = content;
    messageLog.appendChild(logEntry);
    
    // è‡ªå‹•æ»¾å‹•
    if (autoScroll.checked && !logPaused) {
      messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    // é™åˆ¶æ—¥èªŒæ¢ç›®æ•¸é‡
    while (messageLog.children.length > 1000) {
      messageLog.removeChild(messageLog.firstChild);
    }
  }
  
  // æ›´æ–°çµ±è¨ˆ
  function updateStats() {
    statReceived.textContent = stats.received;
    statSent.textContent = stats.sent;
    statFrameData.textContent = stats.frameData;
    statErrors.textContent = stats.errors;
    
    if (stats.connectTime) {
      const uptime = Math.floor((Date.now() - stats.connectTime) / 1000);
      statUptime.textContent = `${uptime}s`;
    } else {
      statUptime.textContent = '0s';
    }
    
    // è¨ˆç®— FPS
    if (stats.frameTimes.length > 0) {
      const avgFrameTime = stats.frameTimes.reduce((a, b) => a + b) / stats.frameTimes.length;
      const fps = 1000 / avgFrameTime;
      statFps.textContent = fps.toFixed(1);
      statFps.style.color = fps >= 35 ? '#10b981' : fps >= 20 ? '#f59e0b' : '#ef4444';
    }
  }
  
  // é€£æ¥æ¨¡å¼è®Šæ›´
  connectionModeEl.addEventListener('change', () => {
    mode = connectionModeEl.value;
    
    if (mode === 'monitor') {
      wsUrlEl.value = `ws://{{ request.get_host }}/ws/light/monitor/`;
      sendPanel.style.opacity = '0.5';
      sendBtn.disabled = true;
    } else {
      wsUrlEl.value = `ws://{{ request.get_host }}/ws/light/playback/`;
      sendPanel.style.opacity = '1';
      sendBtn.disabled = false;
    }
    
    log(`æ¨¡å¼åˆ‡æ›ç‚º: ${mode}`, 'info');
  });
  
  // é€£æ¥ WebSocket
  function connect() {
    const url = wsUrlEl.value;
    
    log(`å˜—è©¦é€£æ¥åˆ°: ${url} (æ¨¡å¼: ${mode})`, 'info');
    
    try {
      ws = new WebSocket(url);
      
      ws.onopen = () => {
        connected = true;
        stats.connectTime = Date.now();
        statusEl.textContent = `âœ… å·²é€£æ¥ (${mode})`;
        statusEl.style.color = '#059669';
        log(`WebSocket é€£æ¥æˆåŠŸ (${mode} æ¨¡å¼)`, 'success');
        updateStats();
      };
      
      ws.onmessage = (event) => {
        stats.received++;
        
        try {
          const data = JSON.parse(event.data);
          const msgType = data.type;
          
          // æ›´æ–°çµ±è¨ˆ
          if (msgType === 'frame_data' || msgType === 'frame_data_all') {
            stats.frameData++;
            
            // æ›´æ–° FPS çµ±è¨ˆ
            const now = performance.now();
            if (stats.lastFrameTime > 0) {
              const frameTime = now - stats.lastFrameTime;
              stats.frameTimes.push(frameTime);
              if (stats.frameTimes.length > 60) {
                stats.frameTimes.shift();
              }
            }
            stats.lastFrameTime = now;
          }
          
          // è¨˜éŒ„è¨Šæ¯
          const typeMap = {
            'connection': 'connection',
            'disconnection': 'connection',
            'client_message': 'client_message',
            'frame_data': 'frame_data',
            'frame_data_all': 'frame_data_all',
            'playback_started': 'playback',
            'playback_paused': 'playback',
            'playback_stopped': 'playback',
            'playback_ready': 'playback',
            'error': 'error',
            'playback_error': 'error',
          };
          
          const logType = typeMap[msgType] || 'received';
          log(`â¬‡ï¸ ${msgType}`, logType, data);
          
        } catch (error) {
          log(`â¬‡ï¸ æ¥æ”¶ (é JSON): ${event.data.substring(0, 100)}...`, 'received');
        }
        
        updateStats();
      };
      
      ws.onclose = (event) => {
        connected = false;
        stats.connectTime = null;
        stats.frameTimes = [];
        statusEl.textContent = 'âŒ æœªé€£æ¥';
        statusEl.style.color = '#dc2626';
        log(`WebSocket é€£æ¥é—œé–‰ (code: ${event.code}, reason: ${event.reason || 'ç„¡'})`, 'warning');
        updateStats();
      };
      
      ws.onerror = (error) => {
        stats.errors++;
        log(`WebSocket éŒ¯èª¤`, 'error');
        updateStats();
      };
      
    } catch (error) {
      stats.errors++;
      log(`é€£æ¥å¤±æ•—: ${error.message}`, 'error');
      updateStats();
    }
  }
  
  // æ–·é–‹é€£æ¥
  function disconnect() {
    if (ws) {
      ws.close();
      ws = null;
      connected = false;
      log('æ‰‹å‹•æ–·é–‹é€£æ¥', 'info');
    }
  }
  
  // ç™¼é€è¨Šæ¯
  function sendMessage() {
    if (!connected) {
      log('è«‹å…ˆé€£æ¥ WebSocket', 'error');
      return;
    }
    
    if (mode === 'monitor') {
      log('ç›£å¯Ÿæ¨¡å¼ä¸èƒ½ç™¼é€æ§åˆ¶è¨Šæ¯', 'warning');
      return;
    }
    
    try {
      const content = messageContentEl.value;
      const data = JSON.parse(content);
      
      ws.send(JSON.stringify(data));
      stats.sent++;
      
      log(`â¬†ï¸ ç™¼é€: ${data.type}`, 'sent', data);
      updateStats();
      
    } catch (error) {
      stats.errors++;
      log(`ç™¼é€å¤±æ•—: ${error.message}`, 'error');
      updateStats();
    }
  }
  
  // æ¸…é™¤æ—¥èªŒ
  function clearLog() {
    messageLog.innerHTML = '<div style="color: #9ca3af;">æ—¥èªŒå·²æ¸…é™¤</div>';
    currentFrameInfo.innerHTML = '<div style="color: #6b7280;">ç­‰å¾…å¹€æ•¸æ“š...</div>';
    slaveDetails.innerHTML = '<div style="color: #6b7280;">é¸æ“‡ä¸€å€‹ slave æŸ¥çœ‹è©³æƒ…...</div>';
    stats.received = 0;
    stats.sent = 0;
    stats.frameData = 0;
    stats.errors = 0;
    stats.frameTimes = [];
    stats.clients.clear();
    lastFrameData = null;
    updateStats();
  }
  
  // æš«åœ/æ¢å¾©æ—¥èªŒ
  function toggleLogPause() {
    logPaused = !logPaused;
    pauseLogBtn.textContent = logPaused ? 'â–¶ï¸ æ¢å¾©' : 'â¸ï¸ æš«åœ';
    pauseLogBtn.style.background = logPaused ? '#10b981' : '#f59e0b';
    log(logPaused ? 'æ—¥èªŒå·²æš«åœ' : 'æ—¥èªŒå·²æ¢å¾©', 'info');
  }
  
  // è¨Šæ¯é¡å‹è®Šæ›´æ™‚æ›´æ–°ç¯„ä¾‹å…§å®¹
  messageTypeEl.addEventListener('change', () => {
    const type = messageTypeEl.value;
    
    const examples = {
      playback_init: { type: 'playback_init', filename: 'show.pxld', slave_id: -1 },
      playback_play: { type: 'playback_play', frame: 0 },
      playback_pause: { type: 'playback_pause' },
      playback_stop: { type: 'playback_stop' },
      playback_seek: { type: 'playback_seek', frame: 100 },
      playback_get_frame: { type: 'playback_get_frame', frame: 0, slave_id: 0 }
    };
    
    if (examples[type]) {
      messageContentEl.value = JSON.stringify(examples[type], null, 2);
    }
  });
  
  // ç¶å®šäº‹ä»¶
  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);
  sendBtn.addEventListener('click', sendMessage);
  clearLogBtn.addEventListener('click', clearLog);
  pauseLogBtn.addEventListener('click', toggleLogPause);
  
  // Ctrl+Enter ç™¼é€
  messageContentEl.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      sendMessage();
    }
  });
  
  // å®šæ™‚æ›´æ–°é‹è¡Œæ™‚é–“
  setInterval(updateStats, 500);
  
  // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
  window.addEventListener('beforeunload', () => {
    if (ws) ws.close();
  });
  
  // è‡ªå‹•é€£æ¥åˆ°ç›£å¯Ÿæ¨¡å¼
  setTimeout(() => {
    if (!connected) {
      log('è‡ªå‹•é€£æ¥åˆ°ç›£å¯Ÿæ¨¡å¼...', 'info');
      connect();
    }
  }, 500);
  
})();
</script>

<style>
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #667eea;
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn:hover:not(:disabled) {
  background: #5568d3;
  transform: translateY(-1px);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

pre {
  background: rgba(0,0,0,0.2);
  padding: 4px 8px;
  border-radius: 4px;
  overflow-x: auto;
}
</style>
{% endblock %}